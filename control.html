<!DOCTYPE html>
<html>
  <head>
		<script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
		<script type="text/javascript" src="/socket.io/socket.io.js"></script>
    
		<title>EVGS - Control</title>
        <meta name="viewport" content="initial-scale=1.0">
        <meta charset="utf-8">
        <style>
            html, body {
                height: 100%;
                margin: 0;
                padding: 0;
            }
            #map {
                height: 100%;
            }
        </style>
  </head>
  <body>
      <div style="position:fixed; top:10px; right:10px; z-index:99999;">PUT CURRENT TIME HERE</div>
      <div id="map"></div>
      <script>      
        var allsignals; 
        var allusers=[];
        var userMarkers=[];
          
        jQuery(function(){
			var socket=io.connect('ws://emergency-vehicle.herokuapp.com/');
//  		    var socket=io.connect('ws://127.0.0.1/');
            
            socket.on('user location',function(data){
                var i;
                console.log("user location change");
                for(i = 0; i < allusers.length; i++){
                   if(allusers[i]._id  == data.user_id){
                       break;
                   } 
                }
            
                userMarkers[i].setPosition( new google.maps.LatLng( data.latitude, data.longitude ) );
                
            });
                    
			socket.on('Change Signal',function(data){
				console.log("Change Signal");
				changeSignal(data);
			});
            
            socket.on('Signal to Green',function(data){
				console.log("Signal to Green"+data);

//                console.log(sigGroup);
                var sigGroup = data.signalGroup;
                for(var i=0; i<allsignals.length; i++){
                    if(allsignals[i].signalGroup == sigGroup){
                        if(allsignals[i]._id == data.signal){
                            changeSignal(i, '#00FF00');
                        }else{
                            changeSignal(i, '#FF0000');
                        }
                    }
                } 
			});
            
            socket.on('Reset Signals',function(data){
				console.log("Reset Signal"+data);
                var sigGroup = data;
//                console.log(sigGroup);
                for(var i=0; i<allsignals.length; i++){
                    if(allsignals[i].signalGroup == sigGroup){
                        changeSignal(i,"#000000");
                    }
                }
			});
            
            socket.on('Init Map',function(data){
                allsignals = data.allsignals;
                allusers = data.allusers;
                console.log(data);
                initMap();
			});
            
              socket.on('Draw Signal',function(data){
                allsignals.push(data);
                var color;
                if(data.status == 0){
                    color="#00000";
                }else if(data.status == 1){
                    color="#00FF00";
                }else if(data.status == -1){
                    color="#FF0000";
                }
                var sigCirc = new google.maps.Circle({
                    strokeColor: color,
                    strokeOpacity: 1,
                    strokeWeight: 2,
                    fillColor: color,
                    fillOpacity: 0.5,
                    map: map,
                    center:  new google.maps.LatLng(data.location.latitude, data.location.longitude),
                    radius: 2
                }); 
                  var signalInfo = new google.maps.InfoWindow({
                    content: "Signal ID: " + data._id + "</br> Signal Group: " +  data.signalGroup + "</br> X-Activation: " + data.activationDirection.Xaxis + "&nbsp; Y-Activation: " + data.activationDirection.Yaxis
                });
//onclick=socket.emit('DeleteSignal',\""+signal._id+"\")
                    
                sigCirc.addListener('click', function(ev) {
                    signalInfo.setPosition(ev.latLng);
                    signalInfo.open(map);
                });
                  
                signalCircle.push(sigCirc);
            });
        });	
	
        function changeSignal(s, color){
            signalCircle[s].setOptions({strokeColor:color, fillColor:color});
        }	
			
        
        var map;
        var signalCircle=[];
    
        function initMap() {			
            console.log("Init Map called");
            map = new google.maps.Map(document.getElementById('map'), {
                center: {lat:19.06356, lng: 72.83511},
                zoom: 19,
				styles: [
                    {
                        featureType: 'road',
                        elementType: 'all',
                        stylers: [
                            { visibility: 'on' }
                        ]
                    },
                    {
                        featureType: 'poi',
                        elementType: 'all',
                        stylers: [
                            { visibility: 'off' }
                        ]
                    }             
                ]
            });
				
            var count=0;
            
            allsignals.forEach(function(signal){
                // Add the circle for this city to the map.
                console.log(signal);
                var color;
                if(signal.status == 0){
                    color="#00000";
                }else if(signal.status == 1){
                    color="#00FF00";
                }else if(signal.status == -1){
                    color="#FF0000";
                }
                signalCircle[count] = new google.maps.Circle({
                    strokeColor: color,
                    strokeOpacity: 1,
                    strokeWeight: 2,
                    fillColor: color,
                    fillOpacity: 0.5,
                    map: map,
                    center:  new google.maps.LatLng(signal.location.latitude, signal.location.longitude),
                    radius: 2
                }); 
                
                var signalInfo = new google.maps.InfoWindow({
                    content: "Signal ID: " + signal._id + "</br> Signal Group: " +  signal.signalGroup + "</br> X-Activation: " + signal.activationDirection.Xaxis + "&nbsp; Y-Activation: " + signal.activationDirection.Yaxis
                });
//onclick=socket.emit('DeleteSignal',\""+signal._id+"\")
                    
                signalCircle[count].addListener('click', function(ev) {
                    signalInfo.setPosition(ev.latLng);
                    signalInfo.open(map);
                });
                
                count++;
            });
            
            allusers.forEach(function(user){
                console.log(user);
                var url;
                var size;
                
                if(user.vehicle_type=='Police Vehicle'){
//                    url = 'http://emergency-vehicle.herokuapp.com/police.png'+'#'+user._id;
                    url = 'http://emergency-vehicle.herokuapp.com/police1.png'+'#'+user._id;
                }   
                else if(user.vehicle_type=='Ambulance'){
//                    url = 'http://emergency-vehicle.herokuapp.com/ambulance.png'+'#'+user._id;
                    url = 'http://emergency-vehicle.herokuapp.com/ambulance1.png'+'#'+user._id;
                }
                else{
//                    url='http://emergency-vehicle.herokuapp.com/fire.png'+'#'+user._id;
                    url = 'http://emergency-vehicle.herokuapp.com/firetruck1.png'+'#'+user._id;
                }
                    
                size =  new google.maps.Size(50, 50);
                var marker = new google.maps.Marker({
                    position: new google.maps.LatLng(user.location.latitude, user.location.longitude),
                    icon: {
                        url:url,
                        scaledSize :size
                    },
                    map: map
                });

                userMarkers.push(marker);
                var infowindow = new google.maps.InfoWindow({
                    content: user.name + "</br>" + user.vehicle_registration + "</br>" + user.location.last_updated
                });

                marker.addListener('click', function() {
                    infowindow.open(map, marker);
                });
            });
            console.log(userMarkers);
            
//            var trafficLayer = new google.maps.TrafficLayer();
//            trafficLayer.setMap(map);
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD31tprRrsm610HlrgAYPXkET_UX3ZRHZU"
    async defer></script>
  </body>
</html>